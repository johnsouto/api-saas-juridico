services:
  traefik:
    # Production-only Traefik settings:
    # - HTTP -> HTTPS redirect
    # - Let's Encrypt certificates (HTTP-01 challenge)
    command:
      - --api.dashboard=true
      - --api.insecure=true
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --entrypoints.web.address=:80
      - --entrypoints.web.http.redirections.entrypoint.to=websecure
      - --entrypoints.web.http.redirections.entrypoint.scheme=https
      - --entrypoints.websecure.address=:443
      # Use the `le` resolver by default for all TLS routers.
      - --entrypoints.websecure.http.tls.certresolver=le
      - --accesslog=true
      - --log.level=INFO
      - --certificatesresolvers.le.acme.email=${LETSENCRYPT_EMAIL}
      - --certificatesresolvers.le.acme.storage=/letsencrypt/acme.json
      - --certificatesresolvers.le.acme.httpchallenge=true
      - --certificatesresolvers.le.acme.httpchallenge.entrypoint=web
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik_letsencrypt:/letsencrypt

  # Production routing (same-origin: https://elementojuris.cloud + https://elementojuris.cloud/api/*)
  api:
    labels:
      - traefik.enable=true

      # Global protection for the API service
      # - Concurrency limit (in-flight requests): 30 simultaneous requests
      - traefik.http.middlewares.api-inflight.inflightreq.amount=30

      # Sensitive endpoints abuse protection (per client IP):
      # 10 requests per minute + small burst (token bucket)
      - traefik.http.middlewares.api-ratelimit-sensitive.ratelimit.average=10
      - traefik.http.middlewares.api-ratelimit-sensitive.ratelimit.period=1m
      - traefik.http.middlewares.api-ratelimit-sensitive.ratelimit.burst=10
      - traefik.http.middlewares.api-ratelimit-sensitive.ratelimit.sourcecriterion.ipstrategy.depth=1

      # Apply concurrency limit to all API routes
      - traefik.http.routers.api-http.middlewares=api-inflight
      - traefik.http.routers.api-http.rule=(Host(`elementojuris.cloud`) || Host(`www.elementojuris.cloud`)) && PathPrefix(`/api`)
      - traefik.http.routers.api-http.entrypoints=web
      - traefik.http.routers.api-http.priority=100
      - traefik.http.routers.api-http.service=api

      - traefik.http.routers.api-https.middlewares=api-inflight
      - traefik.http.routers.api-https.rule=(Host(`elementojuris.cloud`) || Host(`www.elementojuris.cloud`)) && PathPrefix(`/api`)
      - traefik.http.routers.api-https.entrypoints=websecure
      - traefik.http.routers.api-https.tls=true
      - traefik.http.routers.api-https.tls.certresolver=le
      - traefik.http.routers.api-https.priority=100
      - traefik.http.routers.api-https.service=api

      # Rate limit only the most abused endpoints (/auth/* and /platform/*).
      # We use dedicated routers with higher priority so they win over the generic /api router.
      - traefik.http.routers.api-auth-https.rule=(Host(`elementojuris.cloud`) || Host(`www.elementojuris.cloud`)) && PathPrefix(`/api/v1/auth`)
      - traefik.http.routers.api-auth-https.entrypoints=websecure
      - traefik.http.routers.api-auth-https.tls=true
      - traefik.http.routers.api-auth-https.tls.certresolver=le
      - traefik.http.routers.api-auth-https.priority=200
      - traefik.http.routers.api-auth-https.middlewares=api-inflight,api-ratelimit-sensitive
      - traefik.http.routers.api-auth-https.service=api

      - traefik.http.routers.api-platform-https.rule=(Host(`elementojuris.cloud`) || Host(`www.elementojuris.cloud`)) && PathPrefix(`/api/v1/platform`)
      - traefik.http.routers.api-platform-https.entrypoints=websecure
      - traefik.http.routers.api-platform-https.tls=true
      - traefik.http.routers.api-platform-https.tls.certresolver=le
      - traefik.http.routers.api-platform-https.priority=200
      - traefik.http.routers.api-platform-https.middlewares=api-inflight,api-ratelimit-sensitive
      - traefik.http.routers.api-platform-https.service=api

      # Dedicated health router (used by CI deploy health checks). This is intentionally explicit
      # so it keeps working even if the generic /api router is misconfigured.
      - traefik.http.routers.api-health-https.rule=(Host(`elementojuris.cloud`) || Host(`www.elementojuris.cloud`)) && Path(`/api/health`)
      - traefik.http.routers.api-health-https.entrypoints=websecure
      - traefik.http.routers.api-health-https.tls=true
      - traefik.http.routers.api-health-https.tls.certresolver=le
      - traefik.http.routers.api-health-https.priority=300
      - traefik.http.routers.api-health-https.middlewares=api-inflight
      - traefik.http.routers.api-health-https.service=api

      - traefik.http.services.api.loadbalancer.server.port=8000

  web:
    labels:
      - traefik.enable=true

      - traefik.http.routers.web-http.rule=(Host(`elementojuris.cloud`) || Host(`www.elementojuris.cloud`)) && !PathPrefix(`/api`)
      - traefik.http.routers.web-http.entrypoints=web
      - traefik.http.routers.web-http.priority=1

      - traefik.http.routers.web-https.rule=(Host(`elementojuris.cloud`) || Host(`www.elementojuris.cloud`)) && !PathPrefix(`/api`)
      - traefik.http.routers.web-https.entrypoints=websecure
      - traefik.http.routers.web-https.tls=true
      - traefik.http.routers.web-https.tls.certresolver=le
      - traefik.http.routers.web-https.priority=1

      - traefik.http.services.web.loadbalancer.server.port=3000

volumes:
  traefik_letsencrypt:
