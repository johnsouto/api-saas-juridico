name: Deploy (VPS)

on:
  push:
    branches: ["main"]
  workflow_dispatch: {}

concurrency:
  group: deploy-vps-production
  cancel-in-progress: true

jobs:
  deploy:
    name: Deploy to VPS via SSH
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure SSH
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${{ secrets.VPS_HOST }}" ] || [ -z "${{ secrets.VPS_USER }}" ] || [ -z "${{ secrets.VPS_PATH }}" ] || [ -z "${{ secrets.VPS_SSH_KEY }}" ]; then
            echo "Missing required secrets. Please set: VPS_HOST, VPS_USER, VPS_PATH, VPS_SSH_KEY"
            exit 1
          fi

          mkdir -p ~/.ssh
          # Write the private key to disk. Some copy/paste flows introduce CRLF, so we normalize it.
          printf "%s" "${{ secrets.VPS_SSH_KEY }}" | tr -d '\r' > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

          # Validate the key format early to avoid a confusing ssh exit code 255 later.
          ssh-keygen -y -f ~/.ssh/id_ed25519 >/dev/null

          # Add VPS host key (simple approach).
          # If you want stricter security, replace this with a pinned known_hosts entry.
          ssh-keyscan -H "${{ secrets.VPS_HOST }}" >> ~/.ssh/known_hosts

      - name: Deploy
        shell: bash
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PATH: ${{ secrets.VPS_PATH }}
        run: |
          set -euo pipefail

          ssh -o BatchMode=yes -o ConnectTimeout=15 -o StrictHostKeyChecking=yes "${VPS_USER}@${VPS_HOST}" "set -euo pipefail; \
            cd '${VPS_PATH}'; \
            git pull --ff-only; \
            docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d --build traefik api web; \
            docker compose ps"
